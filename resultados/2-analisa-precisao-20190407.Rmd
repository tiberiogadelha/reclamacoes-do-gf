---
title: "Análise da precisão"
output: html_notebook
---

```{r}
library(tidyverse)
library(here)
library(modelr)
library(broom)

theme_set(theme_bw())
```

## Os dados

```{r carrega}

reclamacoes = read_csv(here("data/3-avaliacao-humana/reclamacoes-avaliadas-20190515.csv"))

reclamacoes = reclamacoes %>%
            select(id, orgao, data, titulo, texto, grupo_avaliando = 'Grupo que vai avaliar', insatisfacao, avaliadores, range.avaliacoes)


sentimentos = read_csv(here("data/5-sentimentos/sentimento2019.csv"))

reclamacoes <- reclamacoes %>% mutate(comprimento_titulo = str_length(titulo))
reclamacoes = reclamacoes %>% mutate(comprimento_reclamacao = str_length(texto))
```

`reclamacoes_l` tem um formato long em vez de wide (explicado [aqui](https://sejdemyr.github.io/r-tutorials/basics/wide-and-long/)).

```{r junta}
reclamacoes = reclamacoes %>% 
    left_join(sentimentos, by = "id")


reclamacoes_l = reclamacoes %>%  
    select(-palavras_op30, -palavras_sent, -grupo_avaliando) %>% 
    gather(key = "lexico", 
           value = "polaridade", 
           sentimento_op30, sentimento_sent)


```

Funções usada durante o projeto
```{r}
normaliza = function(lexico, polaridade) {
    if(lexico == "sentimento_op30"){
        return ((((polaridade - minimo_op30)/(maximo_op30 - minimo_op30)) * -4) + 5)
    } else {
        return ((((polaridade - minimo_sent)/(maximo_sent - minimo_sent)) * -4) + 5)
    }
}
```

Converte polaridades para escala 1-5

```{r}
maximo_op30 = max(sentimentos %>%  select(sentimento_op30))
minimo_op30 = min(sentimentos %>%  select(sentimento_op30))
maximo_sent = max(sentimentos %>%   select(sentimento_sent))
minimo_sent = min(sentimentos %>%   select(sentimento_sent))

# Faça você mesmo. Crie a variável polaridade_normalizada

reclamacoes_polarizada = reclamacoes_l %>% 
     mutate(polaridade_normalizada = normaliza(lexico, polaridade))

```

Calcula o erro (SSE) por reclamação. (Erro quadático).

```{r}
reclamacoes_polarizada = reclamacoes_polarizada %>% 
    mutate(erro = (insatisfacao - polaridade_normalizada) ** 2 )
```


## EDA

Inicial. Faça os gráficos a mais que achar necessário para entender os dados que temos de resultado. Lembrando de nossa questão: Quão eficazes são os métodos de análise de sentimento baseados em léxicos para estimar o nível de insatisfação de reclamações recebidas pelo reclameaqui do governo federal? Existe um exemplo de EDA no repositório. Uma decisão importante a ser usada é se vamos considerar as avaliações humanas onde houve muita discordância sobre o nível de insatisfação.

### Questionamentos:
1) Há diferença no tamanho da reclamação por cada órgão?
```{r}
reclamacoes_polarizada %>% 
  filter(complete.cases(.)) %>% 
  ggplot(aes(fill = orgao, x = comprimento_reclamacao), na.rm = TRUE) + 
  geom_histogram(binwidth = 50, na.rm = TRUE) + 
  facet_grid(orgao ~ .)

reclamacoes_polarizada %>% group_by(orgao) %>% 
  ggplot(aes(x = reorder(orgao, comprimento_reclamacao), y=comprimento_reclamacao)) + geom_boxplot()

```
Observando os gráficos gerados é possível ver que  há uma pequena diferença dos tamanhos das reclamações por órgão. A ANATEL, em média, tem as reclamações com maior descrição.

2) Os tamanhos das reclamações ou títulos têm alguma relação com o nível de insatisfação de acordo com o tipo de avaliação (Humana, sent, op30)?
```{r}
reclamacoes %>% ggplot(aes(x = insatisfacao, y = comprimento_reclamacao)) + geom_point()
```

```{r}
reclamacoes %>% ggplot(aes(x = insatisfacao, y= comprimento_titulo)) + geom_point()
```

```{r}
normalizado_sent = reclamacoes %>%  
    select(id, sentimento_sent, comprimento_reclamacao, comprimento_titulo) %>% 
    mutate(normalizada_sent = normaliza("sentimento_sent", sentimento_sent))

normalizado_op30 = reclamacoes %>%  
    select(id, sentimento_op30, comprimento_reclamacao, comprimento_titulo) %>% 
    mutate(normalizada_op30 = normaliza("sentimento_op30", sentimento_op30))
```

```{r}
## Gráficos que apresentam Avaliação gerada pelo sentimento normalizado(op30 ou sent) x Comprimento da descrição da reclamação
normalizado_sent %>%  ggplot(aes(x = normalizada_sent, y = comprimento_reclamacao)) + geom_point()
```

```{r}
normalizado_op30 %>% ggplot(aes(x = normalizada_op30, y= comprimento_titulo)) + geom_point()
```

```{r}
## Gráfico que apresenta Avaliação gerada pelo sentimento normalizado(op30 ou sent) x Comprimento do título
normalizado_sent %>%  ggplot(aes(x = normalizada_sent, y = comprimento_titulo)) + geom_point()
```
```{r}
normalizado_op30 %>% ggplot(aes(x = normalizada_op30, y= comprimento_titulo)) + geom_point()
```
Analisando os gráficos, é possível analisar que não há uma relação muito grande entre o tamanho do texto e a insatisfação. Já que as maiores descrições estão entre 2 e 3,5. 

###Como avaliar a eficácia dos métodos?  
Uma medida interessante da eficiência desses métodos é calcular a soma dos erros ao quadrado (SSE) considerando o que o método definiu como a polaridade_normalizada e o que a avaliação humana definiu como a insatisfação.

```{r}
reclamacoes %>% 
    ggplot(aes(x = sentimento_op30, y = sentimento_sent)) + 
    geom_abline(slope = 1, intercept = 0, color = "blue") + 
    geom_count(alpha = .7) 

```

```{r}
reclamacoes_polarizada %>% 
    ggplot(aes(x = insatisfacao, y = polaridade_normalizada, group = insatisfacao)) + 
    geom_abline(slope = 1, intercept = 0, color = "grey") + 
    geom_jitter(alpha = .7)  + 
    facet_wrap(~ lexico)

reclamacoes_polarizada %>% 
    ggplot(aes(x = insatisfacao, y = erro, group = insatisfacao)) + 
    geom_jitter(alpha = .5)  +
    # geom_boxplot() + 
    facet_wrap(~ lexico)
```


## Há relação entre o léxico e o erro?

Agora um modelo para responder sua pergunta.

```{r}
#Cria variável dummy para preditor categórico
reclamacoes_polarizada = reclamacoes_polarizada %>% mutate(lexico.dummy = if_else(lexico == "sentimento_sent", 1, 0))
#Você precisa entender o que fez acima para interpretar sua regressão
#Você pode também criar uma variável dummy para o órgao (se anac ou inss)
reclamacoes_polarizada = reclamacoes_polarizada %>% mutate(orgao.dummy = if_else(orgao == "ANS", 1, 0))
# ggpairs(reclamacoes_l %>% select(<selecione as colulas que vc quer usar aqui>))
# lm1 = lm(<seu modelo>)
```

**Dica** - o texto de resultado que queremos produzir é algo como: 

Regressão múltipla foi utilizada para analisar se VarIndep1 e VarIndep2 tem uma associação significativa com o erro na estimativa de instatisfação da reclemação. Os resultados da regressão indicam que um modelo com os 2 preditores no formato Erro = XXX.VarIndep1 + YYY.VarIndep2 explicam XX,XX% da variância da variável de resposta (R2 = XX,XX). VarIndep1, medida como/em [unidade ou o que é o 0 e o que é 1] tem uma relação significativa com o erro (b = [yy,yy;  zz,zz], IC com 95%), assim como VarIndep2 medida como [unidade ou o que é o 0 e o que é 1] (b = [yy,yy;  zz,zz], IC com 95%). O aumento de 1 unidade de VarIndep1 produz uma mudança de...

